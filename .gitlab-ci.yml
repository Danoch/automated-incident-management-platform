stages:
  - test
  - package
  - deploy

variables:
  AWS_REGION: "us-east-1"
  LAMBDA_FUNCTION_NAME: "incident-response-lambda"
  DEPLOY_PACKAGE: "lambda_function.zip"

before_script:
  - apt-get update && apt-get install -y zip unzip
  - pip install --upgrade awscli boto3  # Install AWS CLI & Boto3

test:
  stage: test
  image: python:3.9  # ✅ Use a Python image
  script:
    - echo "Running tests..."
    - if [ -d "tests" ]; then pip install pytest && pytest tests/; else echo "No tests found, skipping."; fi

package:
  stage: package
  image: python:3.9  # ✅ Use a Python image
  script:
    - cd lambda_package
    - zip -r ../$DEPLOY_PACKAGE lambda_function.py
    - cd ..

deploy:
  stage: deploy
  image: python:3.9  # ✅ Use a Python image
  script:
    - aws lambda update-function-code --function-name $LAMBDA_FUNCTION_NAME --zip-file fileb://$DEPLOY_PACKAGE --region $AWS_REGION
  only:
    - main
